# go toolset 9.5-1733160835-1.22.7-1733160835
FROM registry.access.redhat.com/ubi9/go-toolset:9.5-1739801907@sha256:703937e152d049e62f5aa8ab274a4253468ab70f7b790d92714b37cf0a140555 as builder
ARG TARGETARCH
USER root
WORKDIR /workspace
COPY . .

# renovate: datasource=github-releases depName=pulumi/pulumi
ENV PULUMI_VERSION 3.152.0
RUN GOARCH=${TARGETARCH} make build \
    && if [ "$TARGETARCH" = "amd64" ]; then \
        export PULUMI_URL="https://github.com/pulumi/pulumi/releases/download/v${PULUMI_VERSION}/pulumi-v${PULUMI_VERSION}-linux-x64.tar.gz"; \
    else \
        export PULUMI_URL="https://github.com/pulumi/pulumi/releases/download/v${PULUMI_VERSION}/pulumi-v${PULUMI_VERSION}-linux-arm64.tar.gz"; \
    fi \
    && echo ${PULUMI_URL} \
    && curl -L ${PULUMI_URL} -o pulumicli.tar.gz \
    && tar -xzvf pulumicli.tar.gz 

# ubi 9.5-1732804088
FROM registry.access.redhat.com/ubi9/ubi:9.5-1732804088@sha256:1057dab827c782abcfb9bda0c3900c0966b5066e671d54976a7bcb3a2d1a5e53
ARG TARGETARCH
LABEL org.opencontainers.image.authors="Redhat Developer"

COPY --from=builder /workspace/out/mapt /workspace/pulumi/pulumi /usr/local/bin/

ENV PULUMI_CONFIG_PASSPHRASE "passphrase" 

ENV AWS_SDK_LOAD_CONFIG=1 \
    AWS_CLI_VERSION=2.16.7 \
    AZ_CLI_VERSION=2.61.0

# Pulumi plugins
# renovate: datasource=github-releases depName=pulumi/pulumi-aws
ARG PULUMI_AWS_VERSION=v6.69.0
# renovate: datasource=github-releases depName=pulumi/pulumi-awsx
ARG PULUMI_AWSX_VERSION=v2.21.0
# renovate: datasource=github-releases depName=pulumi/pulumi-azure-native
ARG PULUMI_AZURE_NATIVE_VERSION=v2.88.0
# renovate: datasource=github-releases depName=pulumi/pulumi-command
ARG PULUMI_COMMAND_VERSION=v1.0.1
# renovate: datasource=github-releases depName=pulumi/pulumi-tls
ARG PULUMI_TLS_VERSION=v5.1.0
# renovate: datasource=github-releases depName=pulumi/pulumi-random
ARG PULUMI_RANDOM_VERSION=v4.17.0

RUN mkdir -p /opt/mapt/run \
    && chmod -R 0777 /opt/mapt/run \
    && if [ "$TARGETARCH" = "amd64" ]; then \
        export ARCH_N=x86_64; \ 
    else \
        export ARCH_N=aarch64; \
    fi \
    && export AWS_CLI_URL="https://awscli.amazonaws.com/awscli-exe-linux-${ARCH_N}-${AWS_CLI_VERSION}.zip" \
    && export AZ_CLI_RPM="https://packages.microsoft.com/rhel/9.0/prod/Packages/a/azure-cli-${AZ_CLI_VERSION}-1.el9.${ARCH_N}.rpm" \
    && echo ${AWS_CLI_URL} ${AZ_CLI_RPM} \
    && curl ${AWS_CLI_URL} -o awscliv2.zip \
    && dnf install -y unzip \
    && unzip -qq awscliv2.zip \
    && ./aws/install \
    && curl -L ${AZ_CLI_RPM} -o azure-cli.rpm \
    && dnf install -y azure-cli.rpm \
    && rm -rf aws awscliv2.zip azure-cli.rpm \
    && dnf clean all \
  	&& rm -rf /var/cache/yum \
    && pulumi plugin install resource aws ${PULUMI_AWS_VERSION} \
    && pulumi plugin install resource azure-native ${PULUMI_AZURE_NATIVE_VERSION} \
    && pulumi plugin install resource command ${PULUMI_COMMAND_VERSION} \
    && pulumi plugin install resource tls ${PULUMI_TLS_VERSION} \
    && pulumi plugin install resource random ${PULUMI_RANDOM_VERSION} \
    && pulumi plugin install resource awsx ${PULUMI_AWSX_VERSION}

ENV PULUMI_HOME "/opt/mapt/run" 
WORKDIR ${PULUMI_HOME}
    
ENTRYPOINT ["mapt"]
# Default to show help
CMD ["-h"]

